<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:content="http://purl.org/rss/1.0/modules/content/" xmlns:media="http://search.yahoo.com/mrss/"><channel><title>Dotnet on Marco Bacis</title><link>https://marcobacis.com/tags/dotnet/</link><description>Recent content in Dotnet on Marco Bacis</description><language>en-uk</language><copyright>¬© Copyright Marco Bacis</copyright><lastBuildDate>Tue, 21 Jan 2025 00:00:00 +0000</lastBuildDate><atom:link href="https://marcobacis.com/tags/dotnet/index.xml" rel="self" type="application/rss+xml"/><item><title>Translating Enums with the power of C# expressions</title><link>https://marcobacis.com/blog/dotnet-enum-translation-expression/</link><pubDate>Tue, 21 Jan 2025 00:00:00 +0000</pubDate><guid>https://marcobacis.com/blog/dotnet-enum-translation-expression/</guid><description>&lt;p>Hi üëã welcome to a new post!&lt;/p>
&lt;p>As a wise man said (forgot the name), &amp;ldquo;Frustration is the mother of innovation&amp;rdquo;.&lt;/p>
&lt;p>For one of my projects at work, I needed to query and sort some tables. The requirement was to let the user filter and sort the data on any field.&lt;/p>
&lt;p>What I didn&amp;rsquo;t expect was that some fields were &lt;code>enum&lt;/code> values under the hood&amp;hellip;. how should I filter/sort these values, when the user searches using their text representation (and, even more difficult, translated in their language)?&lt;/p></description><content:encoded><![CDATA[
          <p>Hi üëã welcome to a new post!</p>
<p>As a wise man said (forgot the name), &ldquo;Frustration is the mother of innovation&rdquo;.</p>
<p>For one of my projects at work, I needed to query and sort some tables. The requirement was to let the user filter and sort the data on any field.</p>
<p>What I didn&rsquo;t expect was that some fields were <code>enum</code> values under the hood&hellip;. how should I filter/sort these values, when the user searches using their text representation (and, even more difficult, translated in their language)?</p>
<p>In this post, I will show how I solved this issue with a nice, little utility function. Since our projects are in .NET, the solution leverages EF Core, Automapper and the power of C# Expression trees.</p>
<p>Let&rsquo;s start!</p>
<h2 id="what-we-are-trying-to-do">What we are trying to do</h2>
<p>Let&rsquo;s start with an example. This is the entity we&rsquo;re going to query:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">enum</span> Status {
</span></span><span style="display:flex;"><span>	Created,
</span></span><span style="display:flex;"><span>	PaymentSuccessful,
</span></span><span style="display:flex;"><span>	PaymentFailed,
</span></span><span style="display:flex;"><span>	Shipped,
</span></span><span style="display:flex;"><span>	Delivered
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Order</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">int</span> Id { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// ... other fields</span>
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">public</span> Status CurrentStatus { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">set</span>; }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Our goal is to present the user with a list of the orders in the system. The user wants to search the list using a generic query (e.g. an input text) and sort the values based on their <strong>text representation</strong>. Yes, also for our <code>Status</code> field!</p>
<p>This is a nightmare if the application is translated into multiple languages. Our application will have to filter the records not based on the enum&rsquo;s description, but on its translation.</p>
<p>For example, the user might type &ldquo;Shi&rdquo; and we should return only the orders with status <code>Shipped</code> if he speaks english. In other languages, the status will have a different translation (e.g. in italian it will be &ldquo;Spedito¬®) which doesn¬¥t match with the query.</p>
<p>When dealing with localization, the first option we have is to deal with it on the frontend. We create some json files with the correct translations and apply them to the UI. While this could be an option to visualize the data, it becomes more difficult when querying it.</p>
<p>Another option would be to select the correct value on the frontend using the translated text, then sen its original (numeric) representation to the backend.</p>
<p>In our case, we&rsquo;d like to search on multiple fields, which makes this approach more complex. Also, I wanted to expose a standard interface to the frontend (see below), so we&rsquo;ll see the backend-only solution!</p>
<p>Here&rsquo;s the endpoint I came up with. It&rsquo;s implemented using <em>.NET 8 Minimal APIs</em> and <em>Entity Framework Core</em>. I also used <a href="https://alirezanet.github.io/Gridify/"  target="_blank" >Gridify</a> to <em>automagically</em> apply filtering, sorting and paging to the data.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>app.MapGet(  
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;/orders&#34;</span>,  
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">async</span> (  
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">            [AsParameters]</span> GridifyQuery gridifyQuery,  
</span></span><span style="display:flex;"><span>            AppDbContext dbContext,  
</span></span><span style="display:flex;"><span>            IMapper mapper,  
</span></span><span style="display:flex;"><span>            CancellationToken cancellationToken  
</span></span><span style="display:flex;"><span>        ) =&gt;  
</span></span><span style="display:flex;"><span>        {  
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">var</span> ordersQuery = dbContext.Orders
</span></span><span style="display:flex;"><span>		        .ProjectTo&lt;OrderDto&gt;(mapper.ConfigurationProvider);  
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">var</span> count = <span style="color:#66d9ef">await</span> ordersQuery
</span></span><span style="display:flex;"><span>		        .ApplyFiltering(gridifyQuery).CountAsync();  
</span></span><span style="display:flex;"><span>		            
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">var</span> data = <span style="color:#66d9ef">await</span> ordersQuery  
</span></span><span style="display:flex;"><span>                .ApplyFilteringOrderingPaging(gridifyQuery)  
</span></span><span style="display:flex;"><span>                .ToListAsync(cancellationToken);  
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> Paging&lt;OrderDto&gt;(count, data);  
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    ).WithName(<span style="color:#e6db74">&#34;GetOrders&#34;</span>);
</span></span></code></pre></div><p>First, we get the data inside the Orders table and project it to the final response type. I do this before performing the search/sort to filter based on what the user can see (e.g. our localized enum description, we&rsquo;ll see later).</p>
<p>Then, we use gridify to apply the paging/filtering/sorting to our query and return the data and the total count (so that the frontend can use it to display a list or table).</p>
<p>Seems simple, right? It is! However, if I try to search for some enum values (this can be done by sending a gridify query such as <code>'status = Created'</code>) I get a nasty error from the ORM, saying it cannot translate our code to a SQL query.</p>
<p>Why does this happen, and how can we fix that?</p>
<h2 id="how-automapper-queryable-extensions-work">How automapper queryable extensions work</h2>
<p>Automapper is an object-to-object mapper. It allows to define custom profiles to map any type of object to any other type. In our case, we use automapper to project the entity to the response we want the API to return.</p>
<p>We do this by using automapper&rsquo;s <a href="https://docs.automapper.org/en/stable/Queryable-Extensions.html"  target="_blank" >Queryable extensions</a>. Queryable extensions allow to call the <code>ProjectTo</code> method on a LINQ query. Automapper adds a custom <code>SELECT</code> statement to our query, with the minimum set of fields needed for the mapping to occur. This optimization improves performance by passing less data from the DBMS to the application and also makes our code more readable.</p>
<h4 id="mapping-profile">Mapping profile</h4>
<p>To make automapper work, we need to define a mapping profile for our objects. Usually, automapper maps fields with the same name and type in both objects, making it easier to map simple objects with less code. For more complex mappings, we can provide a custom profile using some configuration methods.</p>
<p>For each complex field we want to map, we provide an <code>Expression</code> that maps that field from the source object. This expression can be simple (e.g. accessing a source field) or more complex (e.g. making operations on top, with conditionals and other procedures).</p>
<p>This is an example of a complex mapping, in which we map the total price of our order to the sum of the prices of each item:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>CreateMap&lt;Order, OrderDto&gt;()
</span></span><span style="display:flex;"><span>	.ForMember(
</span></span><span style="display:flex;"><span>		dst =&gt; dst.TotalPrice,
</span></span><span style="display:flex;"><span>		opt.MapFrom(
</span></span><span style="display:flex;"><span>			src =&gt; src.Items.Select(o =&gt; o.Price * o.Quantity).Sum()
</span></span><span style="display:flex;"><span>		)
</span></span><span style="display:flex;"><span>	);
</span></span></code></pre></div><p>The parameter we pass to the <code>MapFrom</code> method is a lambda, which is interpreted by the C# SDK as an <a href="https://learn.microsoft.com/en-us/dotnet/csharp/advanced-topics/expression-trees/"  target="_blank" >Expression Tree</a>.</p>
<p>Let¬¥s see what are C# expressions, and how they are used.</p>
<h3 id="what-are-c-expression-trees">What are C# <code>Expression</code> trees?</h3>
<p>We just saw that automapper uses expressions to map fields between objects. But what are expressions in C#? Here is a short section to describe what is a C# <code>Expression</code> and how they are used in some libraries. To know more about expressions, see the <a href="https://learn.microsoft.com/en-us/dotnet/csharp/advanced-topics/expression-trees/"  target="_blank" >documentation</a></p>
<p>In layman&rsquo;s terms, an expression tree is a data structure (a tree) which stores a piece of code. In C#, we can define an expression starting from a lambda (such as <code>Func&lt;&gt;</code>). The compiler will parse the code inside our lambda and return the corresponding syntax tree.</p>
<p>Here is an example of how a lambda is expressed using an expression tree:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>Expression&lt;Func&lt;<span style="color:#66d9ef">int</span>, <span style="color:#66d9ef">int</span>&gt;&gt; lambda = n =&gt; n + <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Same as writing</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> parameter = Expression.Parameter(<span style="color:#66d9ef">typeof</span>(<span style="color:#66d9ef">int</span>), <span style="color:#e6db74">&#34;n&#34;</span>);  
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> constant = Expression.Constant(<span style="color:#ae81ff">1</span>);  
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> addition = Expression.Add(parameter, constant);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> lambda = Expression.Lambda&lt;Func&lt;<span style="color:#66d9ef">int</span>, <span style="color:#66d9ef">int</span>&gt;&gt;(addition, parameter);
</span></span></code></pre></div><p>What are expressions used for? The most common use case is in ORM frameworks. For example, Entity Framework can transform a chain of LINQ calls into SQL queries because each operation can be represented with an Expression.</p>
<p>For example, in this code</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>dbContext.Set&lt;Order&gt;().Where(o =&gt; o.Id == <span style="color:#ae81ff">3</span>).ToList()
</span></span></code></pre></div><p>The <code>o =&gt; o.Id == 3</code> is an expression. After creating the underlying <code>IQueryable</code>, EF will traverse the expression tree to optimize it and translate it to SQL. Cool!</p>
<p>Another example is automapper itself. A mapping profile can be created using expressions, to indicate how a given field should be mapped from the source object. When the profile is created, the expression is then used to map the given types. And that&rsquo;s what we are going to use for our use case!</p>
<h3 id="how-resource-files-work-in-net">How resource files work in .NET</h3>
<p>Let&rsquo;s take a small detour from automapper and its magic, to see how localization works in .NET.</p>
<p><a href="https://learn.microsoft.com/en-us/dotnet/core/extensions/resources"  target="_blank" >Resource files</a> have been in the .NET framework since its inception. Basically, a resource file is an XML file (with <code>.resx</code> extension) in which we can put any static data we might need.</p>
<p>Before compilation, a program (<a href="https://learn.microsoft.com/en-us/dotnet/framework/tools/resgen-exe-resource-file-generator"  target="_blank" >resgen</a>) converts these files to source code, which is embedded in the application&rsquo;s assembly and accessed from our code.</p>
<p>In the case of localization, we create a <code>.resx</code> file for every culture we support in our application (for example, <code>EnumTranslations.resx</code> for the default language, <code>EnumTranslations.it.resx</code> for Italian and so on). Each entry is in this format:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>&lt;data name=<span style="color:#e6db74">&#34;Status_Created&#34;</span> xml:space=<span style="color:#e6db74">&#34;preserve&#34;</span>&gt;  
</span></span><span style="display:flex;"><span>  &lt;<span style="color:#66d9ef">value</span>&gt;Created&lt;/<span style="color:#66d9ef">value</span>&gt;  
</span></span><span style="display:flex;"><span>&lt;/data&gt;
</span></span></code></pre></div><p>To enable localization in the app, we add this code in our <code>Program.cs</code>, configuring the path the compiler uses to find the resource files:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>builder.Services.AddLocalization(options =&gt; options.ResourcesPath = <span style="color:#e6db74">&#34;Resources&#34;</span>);
</span></span></code></pre></div><p><a href="https://learn.microsoft.com/en-us/dotnet/core/extensions/localization"  target="_blank" >Under the hood</a>, this line of code registers the services required to get the localized strings from the resource files. In addition to automatic culture detection by .NET (which works both on desktop/console and web applications!), this allows to transparently translate strings.</p>
<h2 id="creating-a-custom-expression-to-translate-enums">Creating a custom expression to translate enums</h2>
<p>Let&rsquo;s go back to our use case and write the mapper for our API. Let¬¥s focus on the enum mapping.</p>
<p>As explained in the previous section, we put the translations in a resx file (<code>EnumTranslations.resx</code>) . To set a convention, let&rsquo;s say each item is in the form <code>&lt;Enum_Name&gt;_&lt;Enum_Value&gt;</code>, so our status enum will have the following fields generated for us:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>EnumTranslations.Status_Created,
</span></span><span style="display:flex;"><span>EnumTranslations.Status_PaymentSuccessful,
</span></span><span style="display:flex;"><span>EnumTranslations.Status_PaymentFailed,
</span></span><span style="display:flex;"><span>EnumTranslations.Status_Shipped,
</span></span><span style="display:flex;"><span>EnumTranslations.Status_Delivered
</span></span></code></pre></div><p>How can we use these fields in our mapping? Unfortunately, C# <code>Expression</code>s have a lot of <a href="https://learn.microsoft.com/en-us/dotnet/csharp/advanced-topics/expression-trees/#limitations"  target="_blank" >limitations</a> and, together with LINQ-specific limits (explained <a href="https://docs.automapper.org/en/stable/Queryable-Extensions.html#supported-mapping-options"  target="_blank" >here</a>) this means that these operations are not allowed (they won¬¥t be translated to SQL):</p>
<ul>
<li><code>if</code> statements</li>
<li>External classes/methods calls</li>
<li>Dictionary access (not even if immutable) to get the right translation</li>
<li><code>switch/case</code> statements to select the right translation</li>
</ul>
<p>I tried many approaches, but the only one I found was to create a cascade of ternary operators to select the correct translation&hellip; here&rsquo;s the mapping for our status field:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>CreateMap&lt;Order, OrderResponse&gt;()
</span></span><span style="display:flex;"><span>	.ForMember(dst =&gt; dst.Status,
</span></span><span style="display:flex;"><span>		opt =&gt; opt.MapFrom(src =&gt;
</span></span><span style="display:flex;"><span>			src.Status = Status.Created ? EnumTranslations.Status_Created :
</span></span><span style="display:flex;"><span>			src.Status = Status.PaymentSuccessful ? EnumTranslations.Status_PaymentSuccessful :
</span></span><span style="display:flex;"><span>			src.Status = Status.PaymentFailed ? EnumTranslations.Status_PaymentFailed :
</span></span><span style="display:flex;"><span>			src.Status = Status.Shipped ? EnumTranslations.Status_Shipped :
</span></span><span style="display:flex;"><span>			src.Status = Status.Delivere ? EnumTranslations.Status_Delivered :
</span></span><span style="display:flex;"><span>			src.Status.ToString())
</span></span><span style="display:flex;"><span>	);
</span></span></code></pre></div><p>This code has some issues we want to fix:</p>
<ul>
<li>It might become duplicated among multiple mapping profiles</li>
<li>It needs to be updated to incorporate new enum values</li>
<li>If the enum has a lot of values there il will be a lot of conditions&hellip;what happens if there is a typo or some parentheses are missed in the expression?</li>
</ul>
<p>In the next section, we&rsquo;ll see how to generate this expression automatically, to prevent errors and make it reusable in multiple mappings and for any kind of enum.</p>
<h2 id="automating-the-process">Automating the process</h2>
<p>The code we implemented above is quite ugly, and here comes the goal of this post: provide a generic method to map enum to (translated) strings without writing all those ternary expressions by hand.</p>
<p>Here&rsquo;s the resulting extension class, with a method that can be applied to any expression accessing an enum:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">EnumTranslatorExpressionExtensions</span>  
</span></span><span style="display:flex;"><span>{  
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> Expression&lt;Func&lt;TSource, <span style="color:#66d9ef">string</span>&gt;&gt; TranslateExpression&lt;TSource, TEnum&gt;(  
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span> Expression&lt;Func&lt;TSource, TEnum&gt;&gt; enumExpression,
</span></span><span style="display:flex;"><span>        Type enumTranslationsType
</span></span><span style="display:flex;"><span>	  ) <span style="color:#66d9ef">where</span> TEnum : Enum  
</span></span><span style="display:flex;"><span>    {  
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">var</span> enumValues = Enum.GetValues(<span style="color:#66d9ef">typeof</span>(TEnum))
</span></span><span style="display:flex;"><span>					        .Cast&lt;TEnum&gt;()
</span></span><span style="display:flex;"><span>					        .ToArray()
</span></span><span style="display:flex;"><span>					        .Reverse();  
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>        Expression ternaryExpression = Expression.Constant(<span style="color:#e6db74">&#34;Unknown&#34;</span>);  
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">foreach</span> (<span style="color:#66d9ef">var</span> enumValue <span style="color:#66d9ef">in</span> enumValues)  
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">var</span> resourceKey = <span style="color:#e6db74">$&#34;{typeof(TEnum).Name}_{enumValue.ToString()}&#34;</span>;  
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">var</span> propertyInfo = enumTranslationsType.GetProperty(  
</span></span><span style="display:flex;"><span>                resourceKey, BindingFlags.NonPublic | BindingFlags.Static  
</span></span><span style="display:flex;"><span>            );  
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">var</span> staticPropertyAccess = Expression.Property(<span style="color:#66d9ef">null</span>, propertyInfo);  
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">var</span> enumValueExpression = Expression.Equal(  
</span></span><span style="display:flex;"><span>                enumExpression.Body,  
</span></span><span style="display:flex;"><span>                Expression.Constant(enumValue)  
</span></span><span style="display:flex;"><span>            );  
</span></span><span style="display:flex;"><span>            ternaryExpression = Expression.Condition(  
</span></span><span style="display:flex;"><span>                enumValueExpression, staticPropertyAccess,ternaryExpression);
</span></span><span style="display:flex;"><span>	    }  
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> Expression.Lambda&lt;Func&lt;TSource, <span style="color:#66d9ef">string</span>&gt;&gt;(  
</span></span><span style="display:flex;"><span>            ternaryExpression, enumExpression.Parameters  
</span></span><span style="display:flex;"><span>        );  
</span></span><span style="display:flex;"><span>    }}
</span></span></code></pre></div><p>The method takes as input the source expression (the lambda we would have passed to automapper) and the type of the generated translations (to access the resource file).</p>
<p>It then gathers all the enum values and constructs the cascade of ternary operators to access all the resource file properties. For each value, we generate the three arguments to the ternary operator:</p>
<ul>
<li>
<p>The condition (<code>enumValueExpression</code>)</p>
<pre><code>input value == enum value
</code></pre>
</li>
<li>
<p>If the condition is true, we return the translated string</p>
<pre><code>EnumTranslations.&lt;Enum-Name&gt;_&lt;Enum_Value&gt;
</code></pre>
</li>
<li>
<p>Otherwise, we go ahead with the other conditions in the chain</p>
</li>
</ul>
<p>The method  has some rough edges, for example;</p>
<ul>
<li>it gives a generic &ldquo;Unknown&rdquo; default value if the enum value is invalid</li>
<li>It needs to be given the type of the class generated from the resx file</li>
</ul>
<p>Even with its drawbacks, we are now able to generate the mapping profile easily!</p>
<p>In my project I added another extension method, to make the generator more specific. The method automatically adds the <code>EnumTranslations</code> type to the call:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">EnumMappingExtensions</span>  
</span></span><span style="display:flex;"><span>{  
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> MapFromTranslatedEnum&lt;TSource, TDestination, TSourceMember&gt;(  
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span> IProjectionMemberConfiguration&lt;TSource, TDestination, <span style="color:#66d9ef">string</span>&gt; mapOptions,  
</span></span><span style="display:flex;"><span>        Expression&lt;Func&lt;TSource, TSourceMember&gt;&gt; mapExpression  
</span></span><span style="display:flex;"><span>    )        <span style="color:#66d9ef">where</span> TSourceMember : Enum  
</span></span><span style="display:flex;"><span>    {  
</span></span><span style="display:flex;"><span>	    mapOptions
</span></span><span style="display:flex;"><span>		    .MapFrom(
</span></span><span style="display:flex;"><span>			    mapExpression.TranslateExpression(<span style="color:#66d9ef">typeof</span>(EnumTranslations)
</span></span><span style="display:flex;"><span>			)
</span></span><span style="display:flex;"><span>		);  
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>And voil√†! Now the mapping profile can be easily written like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>CreateMap&lt;Order, OrderResponse&gt;()  
</span></span><span style="display:flex;"><span>    .ForMember(
</span></span><span style="display:flex;"><span>	    src =&gt; src.Status,
</span></span><span style="display:flex;"><span>	    opt =&gt; opt.MapFromTranslatedEnum(src =&gt; src.Status)
</span></span><span style="display:flex;"><span>	);
</span></span></code></pre></div><h2 id="conclusions">Conclusions</h2>
<p>That&rsquo;s it for today!</p>
<p>In this post, I showed how automapper allows to easily project entities with its queryable extension. In particular, we saw how to translate enum values in their correct language using a nice extension method. I hope this will prove useful to other C# developers out there!</p>
<p>See you!</p>
<p>PS. I left the example code (with a different entity and enum names, called <code>MyEntity</code> and <code>MyEnum</code>) on <a href="https://github.com/marcobacis/dotnet-enum-translation-expression-example/"  target="_blank" >github</a>.</p>

        ]]></content:encoded></item><item><title>Update Conference 2024 Journal</title><link>https://marcobacis.com/blog/2024-update-conference/</link><pubDate>Sun, 01 Dec 2024 00:00:00 +0000</pubDate><guid>https://marcobacis.com/blog/2024-update-conference/</guid><description>&lt;p>Hi! Welcome to a new post üëã .&lt;/p>
&lt;p>It&amp;rsquo;s been a while since the last time I wrote on the blog (June ü•∂). I had a lot to do during the summer (had to organise my wedding üíç) and didn&amp;rsquo;t find inspiration to write. I promise I&amp;rsquo;ll be more active from now on üòÅ.&lt;/p>
&lt;p>BTW, let&amp;rsquo;s get right into business.&lt;/p>
&lt;p>I just got back from &lt;a href="https://www.updateconference.net/" target="_blank" >Update Conference&lt;/a> in Prague! Update is a conference focused on .NET and related technologies (all in Microsoft salsa).&lt;/p></description><media:content url="https://marcobacis.com/blog/2024-update-conference/cover_hu_1e2ac9ed46472755.jpg" width="249" height="267" medium="image" type="image/jpeg"><media:thumbnail url="https://marcobacis.com/blog/2024-update-conference/cover_hu_1e2ac9ed46472755.jpg" width="249" height="267"/></media:content><content:encoded><![CDATA[
        <img src="https://marcobacis.com/blog/2024-update-conference/cover_hu_1e2ac9ed46472755.jpg" title="%!s(<nil>)" alt="%!s(<nil>)"/>
          <p>Hi! Welcome to a new post üëã .</p>
<p>It&rsquo;s been a while since the last time I wrote on the blog (June  ü•∂). I had a lot to do during the summer (had to organise my wedding üíç) and didn&rsquo;t find inspiration to write. I promise I&rsquo;ll be more active from now on üòÅ.</p>
<p>BTW, let&rsquo;s get right into business.</p>
<p>I just got back from <a href="https://www.updateconference.net/"  target="_blank" >Update Conference</a> in Prague! Update is a conference focused on .NET and related technologies (all in Microsoft salsa).</p>
<p>The idea to go there came to my Tech Leader (<a href="https://www.linkedin.com/in/omarmuscatello/"  target="_blank" >Omar</a>) even before joining <a href="https://www.zupit.it/"  target="_blank" >Zupit</a> last year. Given that we use .NET a lot, we decided to go there with the entire team! This served both as a learning experience, and as a way to get together. Working remotely can feel lonely sometimes, so why not have a beer in Prague, and learn something at the same time?</p>
<p>Here&rsquo;s a summary of my experience in Prague.</p>
<h3 id="day-one">Day One</h3>
<p>Day one started with a great breakfast offered by the conference organisers. In general, food was plenty for the entirety of the event (breakfast, lunch and even an happy hour included!).</p>
<p>I had a lot for breakfast, then the talks started. Here they are!</p>
<h4 id="entire-stack-c-al-rodriguezhttpsprogrammeralcom">Entire Stack C# (<a href="https://programmeral.com/"  target="_blank" >Al Rodriguez</a>)</h4>
<p>Al showed the audience how it&rsquo;s possible to build, deploy and test (e2e) an application using (mostly) .NET, in a real &ldquo;full&rdquo; stack scenario!</p>
<p>We are now used to building full-stack applications in .NET (at least, some people do&hellip;not me üòÖ), but Al showed us how to extend the stack to include even DevOps tasks (build, deploy and test). The industry standard is to use multiple tools which use yaml&hellip;but yaml is an ugly language, so why don&rsquo;t we use our strongest skill (.NET) to configure and run them?</p>
<p>During the talk, Al created a sample application in .NET (using Minimal API and Blazor). He then used <a href="https://cakebuild.net/"  target="_blank" >cake</a> and <a href="https://nuke.build/"  target="_blank" >nukebuild</a> to build the project, <a href="https://www.pulumi.com/"  target="_blank" >Pulumi</a> to deploy its infrastructure and <a href="https://playwright.dev/dotnet/"  target="_blank" >Playwright</a> to test the deployed application.</p>
<p>I really liked the concept behind the talk, even if I don&rsquo;t agree with using .NET on the entire stack. I think that having diverse tools and a clear separation between them is better than doing everything in the same environment (looking at you, javascript!). In fact, in Zupit we decided to use terraform instead of Pulumi for exactly this reason.</p>
<h4 id="basic-designs-and-how-we-got-them-wrong-adam-furmanekhttpsadamfurmanekpl">Basic Designs and How We Got Them Wrong (<a href="https://adamfurmanek.pl/"  target="_blank" >Adam Furmanek</a>)</h4>
<p>In his talk, Adam started from basic constructs of programming languages and design patterns, and destroyed them!</p>
<p>First, he started with the Liskov Substitution principle. He explained it, then drilled down on the example that Wikipedia gives (which is slightly wrong w.r.t the definition). Basically, the Liskov principle seems to be applied to properties of a <strong>type</strong>, but instead we should intend it applied to the <strong>behaviour</strong> of a component! Adam insisted that we should document this in contracts (in particular in documentation). I agree, and I add that this properties should be specified and enforced in unit tests!</p>
<p>After that, he listed a lot of constructs we use daily, and proceeded to destroy them: he talked about dependency inversion, inheritance, DRY principles and, most of all, function <em>coloring</em> and async. He mostly showed examples using C#, but the opinions can be extended to any language employing these patterns.</p>
<h4 id="interlude-table-soccer-and-talking-with-people">Interlude: table soccer and talking with people</h4>
<p>This is not a talk summary üòÅ</p>
<p>The great thing about in-presence events is the opportunity to meet and talk with people you don&rsquo;t know, and wouldn&rsquo;t even have the chance to meet when at home or at the office. This was the case for me at this conference!</p>
<p>Right after lunch, we started playing the table soccer (kindly offered by one of the sponsors, <a href="https://www.riganti.cz/en"  target="_blank" >Riganti</a>). After enjoying our time there, we had the chance to stop at the Microsoft booth, and met <a href="https://www.linkedin.com/in/vzaritovsky/"  target="_blank" >Vlad Zarytovskii</a>.</p>
<p>Vlad is lead the F# compiler and tooling team lead. He introduced us to the Microsoft team in Prague (with some italians, like <a href="https://www.linkedin.com/in/marcorossignoli/"  target="_blank" >Marco</a>) and we talked about work in Prague, how Microsoft participates in developer events, and I discovered he worked on some rust projects at Microsoft ü§©. Definitely a great person to know.</p>
<p>This was a nice encounter during the talks, and for me that&rsquo;s why it&rsquo;s worth to participate at this kind of events, even if they seem expensive and useless for some companies. I skipped some talks, but got something even better in exchange.</p>
<h4 id="closing-the-loop-instrumenting-your-applications-with-opentelemetry-alex-thissenhttpsgithubcomalexthissen">Closing the loop: instrumenting your applications with OpenTelemetry (<a href="https://github.com/alexthissen"  target="_blank" >Alex Thissen</a>)</h4>
<p>In the aftrenoon, I was able to attend only one session, and Alex gave a great introduction to OpenTelemetry in .NET. OpenTelemetry is a protocol to expose observability signals from our services.</p>
<p>Alex explained the main signals that we can expose from an application (traces, logs and metrics) and showed how the OpenTelemetry libraries allows to expose these signals easily from our .NET application. I already knew about logs and metrics (used prometheus some time ago), and really liked the introduction to tracing and how easily we can add it to .NET (in a transparent way too!).</p>
<h3 id="day-two">Day Two</h3>
<p>Time for day two! This time, I tried to eat less for breakfast üòÖ. Strong from the previous day of talks, the goal was to attend most of them without playing at the table soccer in the break room.</p>
<p>Let&rsquo;s go!</p>
<h4 id="net-aspire-the-new-way-to-be-cloud-native-with-net-isaac-levinhttpswwwisaaclevincom">.NET Aspire: The new way to be cloud native with .NET (<a href="https://www.isaaclevin.com/"  target="_blank" >Isaac Levin</a>)</h4>
<p>To start the second day, I attended an introduction on <a href="https://learn.microsoft.com/en-us/dotnet/aspire/get-started/aspire-overview"  target="_blank" >.NET Aspire</a> by Isaac Levin. In his talk, he showed what Aspire is, how to run a small project with it, and the wonders of the aspire dashboard.</p>
<p>Aspire is a set of &ldquo;developer productivity&rdquo; tools, allowing to ease the development of distributed applications. In particular, it allows to orchestrate multiple services <em>locally</em> (e.g. developing an application which uses PostgreSQL, Redis and other services) and to deploy them <em>remotely</em> (for now on Azure) using only .NET.</p>
<p>One thing I found interesting from Isaac&rsquo;s talk is the Aspire Dashboard, which allows to collect telemetry signals and monitor our application and related services in a single click with a pre-configured container.</p>
<p>I still think that it&rsquo;s better to keep deployment tools and languages separated from the application code (see the talk above) to keep responsabilities separated, and to enable collaboration among teams with different tech stacks.</p>
<p>Anyway, Aspire was interesting. I think it might be useful as a scaffolding tool for new projects, as it allows to run locally an entire distributed application with fewer lines of code.</p>
<h4 id="let-none-survive-how-to-test-our-unit-tests-with-mutation-testing-stefan-polzhttpsgithubcomflash0ver">Let none survive! How to test our unit tests with mutation testing (<a href="https://github.com/Flash0ver"  target="_blank" >Stefan Polz</a>)</h4>
<p>Testing is a fundamental practice in software development (even more if done before writing production code&hellip;TDD anyone?). But how can we be sure that our tests are working correctly, that our code is thoroughly tested?</p>
<p>Enter the world of Mutation testing!! Stefan showed how mutation testing works, and how we can easily integrate it in our application development using <a href="https://stryker-mutator.io/docs/stryker-net/introduction/"  target="_blank" >Stryker</a>.</p>
<p>I really liked the introduction to mutation testing, and even more the live demo he gave on a sample code. I think mutation testing is a valid addition to our projects. For most applications it might be overkill  (at least in projects I worked on), but it can be useful for &ldquo;safety critical&rdquo; environments (e.g. firmware, medical, defence, aerospace and so on) and for library code, which might be used in wildly different scenarios.</p>
<h4 id="15-years-of-insights-from-a-tdd-practicioner-dennis-doomenhttpswwwdennisdoomencom">15 years of insights from a TDD practicioner (<a href="https://www.dennisdoomen.com/"  target="_blank" >Dennis Doomen</a>)</h4>
<p>Dennis gave a lot of advice on how to make TDD work for you, given his 30 of experience in the field (he&rsquo;s the author of <a href="https://fluentassertions.com/"  target="_blank" >FluentAssertions</a>, which is widely used to write tests afterall!).</p>
<p>I wrote down all his bullet points on a paper notebook, but I&rsquo;m not going to write all of them here, just some concepts I found interesting.</p>
<p>The first is the concept of <em>Unit</em>. In most books and courses, unit testing refers to unit as the single class which should be put under test. Dennis instead recommends to test the outside behaviour of the system (which in some cases is called contract testing), so the unit is usually wider than a single class! The scope of a test should be an entire module (or slice in the case of vertical slicing).</p>
<p>Another interesting advice is to make tests explicit, as they represent the &ldquo;specification&rdquo; of our software. As the agile manifesto says, &ldquo;working code over comprehensive documentation&rdquo;. In the case of TDD, the code is most of the documentation and specification (if it&rsquo;s not written on a test, then it shouldn&rsquo;t happen!), so tests should emphasize the behaviour of the system. Here he talked about naming, expressivity and structure of the tests.</p>
<p>Finally, Dennis recommended to expand the scope of the tests outside the core business logic, integrating the database (without touching it directly from the tests, be aware!) and not employing mocks more than necessary, to test the entire behaviour of the system from the perspective of the user. I agree with his reccomendation, even if sometimes I would like to write smaller tests for some logic of my applications (testing the entire API and database can sometimes be really slow, both in development and in build times).</p>
<p>As always when talking about processes and methodologies, most of the advice has to be taken in the context of each project and team. Most of the bullet points he discussed where contrasting. As developers, it&rsquo;s our work to find the right tradeoffs, while sometimes we can be more &ldquo;dogmatic&rdquo; if we think something is important (e.g. we cannot skip testing at all, but at least we can play with the definition of what a &ldquo;unit&rdquo; is).</p>
<h4 id="lets-design-a-new-c-language-feature-jared-parsonshttpsblogparanoidcodingorg">Let&rsquo;s design a new C# language feature (<a href="https://blog.paranoidcoding.org/"  target="_blank" >Jared Parsons</a>)</h4>
<p>Jared is the C# compiler lead at Microsoft, so he&rsquo;s the real deal when talking about C# features. In his (first, for today) talk, he told the story of a &ldquo;simple&rdquo; C# feature: variable length argument with <code>IEnumerable</code> instead of an array.</p>
<p>Basically, for most of .NET history, if you wanted a variable number of arguments to a method, you would do so by defining an array with the <code>params</code> modifier, like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> method(<span style="color:#66d9ef">params</span> <span style="color:#66d9ef">string</span>[] multipleParams) {}
</span></span></code></pre></div><p>But why does the param needs to be an array, and not any other collection type?</p>
<p>Jared explained why, and how they were finally able to add this feature in .NET 9. Most of the time the feature was low priority (because of the difficulty of implementing it, keeping the compiler retro-compatible and without real users concerns). In the end, the right moment came with the introduction of <code>Span&lt;T&gt;</code> and <a href="https://learn.microsoft.com/en-us/dotnet/csharp/language-reference/proposals/csharp-13.0/params-collections"  target="_blank" >Params collections</a> in C# 12, which made the feature &ldquo;trivial&rdquo; to implement (somewhat).</p>
<p>The story told by Jared highlighted how most of the times what technical people want is not aligned with what the business (and clients) want, but with a happy ending this time!! He also explained how the C# compiler team always thinks about developer experience (for example, why is <code>Select</code> at the end and not at the beginning of a LINQ expression? To allow intellisense to work out the type of the collection and suggest the right methods and types afterward!).</p>
<p>Finally, watching someone talk about language design and compiler features is always interesting, even if I don&rsquo;t understand most of it üòÖ.</p>
<h4 id="exploring-source-generators-in-net-jared-parsonshttpsblogparanoidcodingorg">Exploring Source Generators in .NET (<a href="https://blog.paranoidcoding.org/"  target="_blank" >Jared Parsons</a>)</h4>
<p>The final talk I watched was again from Jared. This time, he gave an introduction to <a href="https://learn.microsoft.com/en-us/dotnet/csharp/roslyn-sdk/#source-generators"  target="_blank" >source generators</a>.</p>
<p>Source generators leverage the C# compiler api to allow <em>compile-time metaprogramming</em>, based on the source code informations given by the compiler. The system is also integrated with IDEs, so it allows to seamlessly compile generated code without the developer intervention. They are really useful and are mostly used in frameworks for mapping, serialization and other boilerplate code (e.g. ORMs).</p>
<p>Jared highlighted the main advantages of source generators w.r.t. systems previously based on msbuild (e.g. razor, wpf, vsix and so on) which need to use intermediate projects/assemblies to work. Source generators allow to work without these limitations, but introduce additional complexity given the incremental nature of modern compilers (e.g. can only generate new files, cannot interact with other generators and are not applied with a given order/priority).</p>
<p>I really enjoyed this talk, as it shows a feature most of us won&rsquo;t directly use in our projects, but are already using without realizing it!</p>
<h2 id="the-end">The End</h2>
<p>That&rsquo;s all for this conference! I really enjoyed my time in Prague. We had fun, got updated on the latest .NET features, discovered new ways of working (e.g. with Aspire, Source Generators and with mutation testing) and most of all, met new people.</p>
<p>I never attended a conference solely centered around .NET, and I think that specialized conferences can be a good source of knowledge and a great way to know people in the (not so small) community of your favourite programming language or framework.</p>
<p>That said, I hope to attend next year event, so see you there!</p>
        ]]></content:encoded></item></channel></rss>